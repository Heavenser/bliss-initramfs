#!/bin/busybox sh

# Copyright (C) 2012 Jonathan Vasquez
#
# This Source Code Form is subject to the terms of the Mozilla Public
# License, v. 2.0. If a copy of the MPL was not distributed with this
# file, You can obtain one at http://mozilla.org/MPL/2.0/.

ZFS_POOL_NAME=""
JV_MOD_PATH=""

echo "Welcome to the Bliss Init Script (BIS)"

#busybox --install -s #Test if this would work

# Function to start rescue shell
rescue_shell() {
	echo "Booting into rescue shell"
	busybox --install -s
	exec /bin/sh
}

# Function to load ZFS modules 
load_modules() {
	MODULES="zlib_deflate zlib spl splat zavl znvpair zcommon zunicode zfs zpios"
	
	for MODULE in ${MODULES}; do
		echo "Attempting to load module: ${MODULE}"
		
		if [ "${MODULE}" = "zlib_deflate" ] || [ "${MODULE}" = "zlib" ]; then
			insmod ${JV_MOD_PATH}/${MODULE}.ko.gz
		else
			insmod ${JV_MOD_PATH}/${MODULE}.ko
		fi
	done
}

# Mount Kernel Devices 
mount -t proc none /proc
mount -t devtmpfs none /dev
mount -t sysfs none /sys

# Wait a little for trailing kernel messages
sleep 2 

# Load ZFS Modules
load_modules || rescue_shell

# Mount ZFS Pool
zpool import -f -d /dev -o cachefile= -R /mnt/root ${ZFS_POOL_NAME} || rescue_shell

# Unmount Kernel Devices
umount /proc
umount /dev
umount /sys

# Switch to the new root
exec switch_root /mnt/root /sbin/init || rescue_shell
