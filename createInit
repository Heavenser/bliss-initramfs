#!/bin/bash

# Copyright (C) 2012 Jonathan Vasquez <jvasquez1011@gmail.com>
#
# This Source Code Form is subject to the terms of the Mozilla Public
# License, v. 2.0. If a copy of the MPL was not distributed with this
# file, You can obtain one at http://mozilla.org/MPL/2.0/.

# Description
# ------------
# This will be the entry point of the application.
# It will display a menu, and depending on the options chosen,
# It will ask for necessary information.
# Once the information is gathered, it will pass that info to
# the appropriate hook in which the initramfs will be created.

# Source functions
. resources/variables.sh
. resources/functions_generic.sh

# If a initrd option was passed, set the 'choice' variable
if [ ! -z ${1} ]; then
	if [ "${1}" -lt 1 ] || [ "${1}" -gt 4 ]; then
		echo "It must be an option between 1-4" && print_options
		exit
	else
		choice=${1}
	fi

	if [ ! -z ${2} ]; then
		# If a kernel was passed, set the KERNEL_NAME variable
		KERNEL_NAME=${2}
	else
		echo "You must also pass a kernel name" && print_usage
		exit
	fi
fi

# This script must be ran as root
if [ $(whoami) != "root" ]; then
        werr "This script must be ran as root"
fi

#######################################################################
# The main entry point starts here
#######################################################################
clear

print_header

print_menu

get_arch

# Check to see if modules directory exists.. only needed for ZFS
if [ ${INIT_TYPE} = "ZFS" ]; then
	check_mods_dir
fi

clean

print_start

create_dirs

# Check preliminary binaries that are needed but won't be placed inside
# the initrd (like cpio)
check_prelim_binaries

check_binaries && check_modules

copy_binaries && copy_modules

# If it's a ZFS initrd, compress the copied modules and generate modules.dep
if [ ${INIT_TYPE} = "ZFS" ]; then
	pack_modules && modules_dep
fi

get_deps

copy_deps

create_symlinks

config_init

create_initrd

#clean_all
